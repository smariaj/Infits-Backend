CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'agent',
    phone VARCHAR(20),
    date_of_joining DATE,
    team VARCHAR(50),
    profile_image VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE call_stats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    type ENUM('in','out','missed') NOT NULL,
    connected BOOLEAN NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE daily_goals (
    user_id INT PRIMARY KEY,
    daily_goal INT DEFAULT 10
);


CREATE TABLE campaigns (
  id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_name VARCHAR(150) NOT NULL,
  description TEXT,
  demographics VARCHAR(255),
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status ENUM('draft', 'active', 'completed') DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE campaign_agents (
  id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_id INT NOT NULL,
  agent_id INT NOT NULL,

  FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
    ON DELETE CASCADE,
  FOREIGN KEY (agent_id) REFERENCES users(id)
    ON DELETE CASCADE,

  UNIQUE (campaign_id, agent_id)
);



CREATE TABLE leads (
  id INT AUTO_INCREMENT PRIMARY KEY,
  campaign_id INT NOT NULL,
  name VARCHAR(100) NOT NULL,
  company VARCHAR(150),
  phone VARCHAR(20),
  email VARCHAR(100),
  status ENUM('New Lead','Interested','Call Back','Converted') DEFAULT 'New Lead',
  assigned_agent_id INT DEFAULT NULL,
  last_activity VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (campaign_id) REFERENCES campaigns(id) ON DELETE CASCADE,
  FOREIGN KEY (assigned_agent_id) REFERENCES users(id) ON DELETE SET NULL
);



CREATE TABLE lead_activities (
    id INT AUTO_INCREMENT PRIMARY KEY,

    lead_id INT NOT NULL,
    user_id INT NOT NULL,

    type ENUM('call', 'email', 'note', 'status') NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_lead_activities_lead
        FOREIGN KEY (lead_id)
        REFERENCES leads(id)
        ON DELETE CASCADE,

    CONSTRAINT fk_lead_activities_user
        FOREIGN KEY (user_id)
        REFERENCES users(id)
        ON DELETE RESTRICT
);


-----------------------------------------------
CREATE TABLE message_templates (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name TEXT NOT NULL,
  message TEXT NOT NULL,
  variables JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );


ALTER TABLE users
ADD COLUMN reset_token VARCHAR(255),
ADD COLUMN reset_token_expiry BIGINT;

ALTER TABLE users ADD accepting_calls BOOLEAN DEFAULT true;


ALTER TABLE campaigns
ADD COLUMN target INT NOT NULL DEFAULT 0,
ADD COLUMN called INT NOT NULL DEFAULT 0;

DELIMITER $$

DROP TRIGGER IF EXISTS trg_sync_lead_status $$

CREATE TRIGGER trg_sync_lead_status
AFTER INSERT ON lead_activities
FOR EACH ROW
BEGIN
  IF NEW.type = 'status'
     AND NEW.description IS NOT NULL THEN

    UPDATE leads
    SET
      status = TRIM(SUBSTRING_INDEX(NEW.description, 'to', -1)),
      last_activity = NEW.created_at
    WHERE id = NEW.lead_id;

  END IF;
END$$

DELIMITER ;

DELIMITER $$

DROP TRIGGER IF EXISTS trg_update_campaign_called $$

CREATE TRIGGER trg_update_campaign_called
AFTER UPDATE ON leads
FOR EACH ROW
BEGIN
  -- Lead moved from NOT-CALLED → CALLED
  IF OLD.status IN ('New Lead', 'Fresh')
     AND NEW.status NOT IN ('New Lead', 'Fresh') THEN

    UPDATE campaigns
    SET called = called + 1
    WHERE id = NEW.campaign_id;

  END IF;

  -- Lead moved from CALLED → NOT-CALLED
  IF OLD.status NOT IN ('New Lead', 'Fresh')
     AND NEW.status IN ('New Lead', 'Fresh') THEN

    UPDATE campaigns
    SET called = GREATEST(called - 1, 0)
    WHERE id = NEW.campaign_id;

  END IF;
END$$

DELIMITER ;

